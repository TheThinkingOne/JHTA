<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leekiye.mybatis">

    <sql id="search">
        <choose>
            <when test="search=='subject'">
                subject like '%'||#{searchWord}||'%'
            </when>
            <when test="search=='content'">
                content like '%'||#{searchWord}||'%'
            </when>
            <when test="search=='username'">
                username like '%'||#{searchWord}||'%'
            </when>
            <otherwise>
                (subject like '%'||#{searchWord}||'%') or
                (content like '%'||#{searchWord}||'%')
            </otherwise>
        </choose>
    </sql>

    <select id="getBoard" resultType="BoardDto"
            parameterType="int">
        SELECT * FROM BOARD WHERE NO = #{NO}
        <!--SELECT * FROM BOARD WHERE N0 = ?-->
<!--        여기선 세미콜론 쓰면안된다 -->
    </select>

    <select id="getBoardList" resultType="BoardDto" parameterType="PageDto">
        SELECT * FROM
        (SELECT ROWNUM AS NUM, b01.* FROM
        (SELECT * FROM BOARD ORDER BY REGROUP DESC, RELEVEL ASC) b01
        ) b02
        WHERE NUM BETWEEN #{start} AND #{end}
    </select>

    <select id="getBoardTotal" resultType="int">
        SELECT COUNT(*) AS TOTAL FROM BOARD
    </select>

    <select id="searchBoard" resultType="BoardDto" parameterType="SearchDto">
        SELECT * FROM
        (SELECT rownum AS num, b01.* from
        (SELECT * FROM board
        WHERE <include refid="search"></include><choose>
            <when test="search=='subject'">
                subject like '%'||#{searchWord}||'%'
            </when>
            <when test="search=='content'">
                content like '%'||#{searchWord}||'%'
            </when>
            <when test="search=='username'">
                username like '%'||#{searchWord}||'%'
            </when>
            <otherwise>
                (subject like '%'||#{searchWord}||'%') or
                (content like '%'||#{searchWord}||'%')
            </otherwise>
        </choose>
        ORDER BY regroup DESC, relevel asc
        )
        b01)
        WHERE num BETWEEN 1 AND 10
    </select>

    <select id="getMaxRegroup" resultType="int">
        SELECT NVL(MAX(REGROUP),0) AS MAX FROM BOARD
    </select>

    <select id="getSearchBoardTotal" resultType="int" parameterType="SearchDto">
        SELECT COUNT(*) AS TOTAL FROM BOARD
        WHERE <include refid="search"></include>
    </select>

    <!-- 게시글 생성 쿼리 -->
    <insert id="writeBoard" parameterType="BoardDto">
        INSERT INTO BOARD VALUES
        (BOARD_SEQ.NEXTVAL,#{subject},#{content},#{userID},#{userName},#{password},#{regroup},
        1,1,1,SYSDATE,1)
    </insert>

    <!-- 댓글 생성 쿼리 -->
    <insert id="replyBoard" parameterType="BoardDto">
        INSERT INTO BOARD VALUES
        (BOARD_SEQ.NEXTVAL,#{subjec},#{content},#{userId},#{userName},
        #{password},#{regroup},
        #{relevel},#{restep},1,SYSDATE,1)
    </insert>

    <delete id="deleteBoard" parameterType="BoardDto">
        <!-- SELECT 빼고는 거의 다 resultType은 필요없다-->
        DELETE FROM BOARD WHERE NO = #{no} AND PASSWORD = #{password}
    </delete>

    <delete id="deleteAllBoard">
        DELETE FROM BOARD WHERE NO IN
        <foreach collection="array" item="item" index="i"
                 open="(" close=")" separator=",">
            #{item}
        </foreach>
    </delete>

    <update id="updateRelevel" parameterType="BoardDto">
        UPDATE BOARD SET RELEVEL = RELEVEL + 1
        WHERE REGROUP = #{regroup} AND RELEVEL > #{relevel}
    </update>

</mapper>