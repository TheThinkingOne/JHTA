<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>시도별 미세먼지 현황</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
      .chart-box {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div class="sidoSelect">
      <select name="cidoSelect" id="sido" style="height: 40px">
        <option value="서울">서울</option>
        <option value="부산">부산</option>
        <option value="대구">대구</option>
        <option value="인천">인천</option>
        <option value="광주">광주</option>
        <option value="대전">대전</option>
        <option value="울산">울산</option>
        <option value="경기">경기</option>
        <option value="강원">강원</option>
        <option value="충북">충북</option>
        <option value="충남">충남</option>
        <option value="전북">전북</option>
        <option value="전남">전남</option>
        <option value="경북">경북</option>
        <option value="경남">경남</option>
        <option value="제주">제주</option>
        <option value="세종">세종</option>
      </select>
      <button class="btn-search" style="height: 40px; width: 80px">검색</button>
    </div>
    <div class="chart-box">
      <canvas id="myChart"></canvas>
    </div>
    <script>
      // $(".btn-search").on("click", function () {
      //     const searchSido = $("#.sido").on("change", function () {
      //       const sido = $(".sido").val();
      //       loadData(searchSido);
      //     });
      //   });
      $(".btn-search").on("click", function () {
        const sido = $("#sido").val();
        console.log(sido);
        loadData(sido);
      });

      const ctx = $("#myChart").get();

      let myChart = null;
      const loadData = function (sido) {
        $.ajax({
          url: "https://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getCtprvnRltmMesureDnsty",
          data: {
            serveiceKey:
              "/iP5dxeDKBDeRjgvmY7hIzy1yeMzt8aJ1NWLvV1h7Lq6qGSNa+g04nI1Dzv8jigeRNXH8gq54KviS+MNxj7Y3w==",
            returnType: "json",
            numOfRows: 100,
            pageNo: 1,
            sidoName: sido,
            ver: "1.0",
          },
          success: function (response) {
            const find10pmList = [];
            const find2dot5pmList = [];

            const items = [...response.response.body.items];
            const labelList = [];

            $.each(items, function (idx, el) {
              find10pmList.push(el.pm10Value);
              find2dot5pmList.push(el.pm25Value);
              labelList.push(el.stationName);
            });
            if (myChart !== null) {
              myChart.destroy();
            }
            myChart = new Chart(ctx, {
              // css 로 넣는 스타일보다 js로 넣은 스타일이 우선권 가짐
              type: "bar",
              data: {
                labels: labelList,
                datasets: [
                  {
                    label: "미세먼지(pm10) 농도",
                    data: find10pmList,
                    borderWidth: 1,
                    // backgroundColor: [
                    //   "#CB4335",
                    //   "#1F618D",
                    //   "#F1C40F",
                    //   "#27AE60",
                    //   "#884EA0",
                    //   "#D35400",
                    // ],
                  },
                  {
                    label: "미세먼지(pm2.5) 농도",
                    data: find2dot5pmList,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    stacked: true,
                  },
                  x: {
                    stacked: true,
                  },
                },
                plugins: {
                  title: {
                    display: true,
                    text: "시도별 미세먼지 농도",
                  },
                },
              },
            });
          },
          error: function (err) {
            alert("잠시후 다시 시도해주세요");
          },
        });
      };
      loadData("서울");
    </script>
  </body>
</html>
